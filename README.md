# Proyectos-SQL
--1.-Análisis de Ventas y Beneficio por Categoría de Producto en 2020
 
USE ROLE TRAINING_ROLE;
USE WAREHOUSE HORNET_WH;
USE DATABASE UCM;
USE SCHEMA SMART_DESK;


SELECT CATEGORY AS CATEGORIA, SUM (MAINTENANCE) AS MANTENIMIENTO, SUM(PRODUCT) AS PRODUCTO, SUM(PARTS) AS PARTES, SUM(SUPPORT) AS SOPORTE, SUM(TOTAL) AS TOTAL_VENTAS, SUM(UNITS_SOLD) AS UNIDADES_VENDIDAS ,SUM(PROFIT) AS BENEFICIO_TOTAL
FROM SALES
WHERE YEAR =2020
GROUP BY CATEGORIA
ORDER BY CATEGORIA


--2. Comparación de Rendimiento por País en Regiones APAC y EMEA 

SELECT 
      A.REGION AS REGION, 
      A.COUNTRY AS PAIS, 
      AVG(S.TOTAL) AS INGRESO_TOTAL, 
      AVG(S.UNITS_SOLD) AS UNIDADES_VENDIDAS_PROMEDIO,
      AVG(S.PROFIT) AS BENEFICIO_PROMEDIO,
FROM ACCOUNTS AS A JOIN SALES AS S
ON A.ACCOUNT = S.ACCOUNT
WHERE A.REGION IN ('APAC', 'EMEA')
GROUP BY A.REGION, A.COUNTRY
ORDER BY REGION
;

--3 Análisis del Beneficio Total por Industria: Estudio de Clientes en Etapa de Compromiso

SELECT 
      A.INDUSTRY AS INDUSTRIA,
      SUM(S.PROFIT) AS TOTAL_PROFIT,
      CASE WHEN SUM(S.PROFIT) > 1000000 THEN 'ALTO'
      ELSE 'NORMAL'
      END AS "BENEFIT_CATEGORY"
      
FROM ACCOUNTS AS A JOIN SALES AS S
ON A.ACCOUNT = S.ACCOUNT
JOIN FORECASTS AS F
ON A.ACCOUNT = F.ACCOUNT
WHERE F.PREDICTION_CATEGORY = 'Commit' AND F.FORECAST > 500000
GROUP BY F.PREDICTION_CATEGORY, A.INDUSTRY



--4. Evolución del Pronóstico y Beneficio Real: Análisis de la Trayectoria por Categoría.

SELECT COALESCE (F.CATEGORY, S.CATEGORY) AS CATEGORIA, 
       COALESCE (SUM(S.PROFIT), 0) AS BENEFICIO, 
       COALESCE (SUM(F.FORECAST), 0) AS PREVISION_BENEFICIO,
       MIN(OPPORTUNITY_AGE) AS OPORTUNIDAD_MAS_RECIENTE, 
       MAX(OPPORTUNITY_AGE) OPORTUNIDAD_MAS_ANTIGUA
FROM SALES AS S FULL OUTER JOIN FORECASTS AS F 
ON S.CATEGORY = F.CATEGORY AND S.YEAR = F.YEAR
GROUP BY COALESCE(F.CATEGORY, S.CATEGORY)
ORDER BY COALESCE(F.CATEGORY, S.CATEGORY);



--ANALISIS LIBRE


--Analisis exploratorio

SELECT 
    A.COUNTRY AS PAIS,
    SUM(S.MAINTENANCE) AS TOTAL_MANTENIMIENTO,
    SUM(S.PRODUCT) AS TOTAL_PRODUCTO,
    SUM(S.PARTS) AS TOTAL_PARTES,
    SUM(S.SUPPORT) AS TOTAL_SOPORTE,
    SUM(S.TOTAL) AS TOTAL_INGRESOS,
    SUM(S.UNITS_SOLD) AS TOTAL_UNIDADES_VENDIDAS,
    SUM(S.PROFIT) AS BENEFICIO_TOTAL
FROM SALES S
JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
GROUP BY A.COUNTRY
ORDER BY BENEFICIO_TOTAL;

--Verificamos cuantos años hay  

SELECT DISTINCT S.YEAR AS ANOS_PREVIOS, F.YEAR AS ANO_DE_PREVISION
FROM SALES AS S JOIN FORECASTS AS F 
GROUP BY S.YEAR, F.YEAR
ORDER BY S.YEAR ASC



--Analizamos hasta qué cuatrimestre se ha hecho el análisis

SELECT YEAR AS ANOS, QUARTER_OF_YEAR AS PARTE
FROM SALES 
GROUP BY YEAR, QUARTER_OF_YEAR
ORDER BY YEAR ASC



--Analisis exploratorio de los ingresos por categoria de producto y servicio 

SELECT DISTINCT YEAR AS ANO, S.CATEGORY AS PRODUCTOS, SUM(S.PRODUCT) AS INGRESOS_PRODUCTOS, SUM(S.PARTS) AS INGRESOS_PARTES, SUM(S.MAINTENANCE) AS INGRESOS_SERVICIOS 
FROM SALES AS S 
GROUP BY ANO, PRODUCTOS
ORDER BY YEAR



--Analisis exploratorio de los beneficios totales en 2019, 2020 y 2021 

SELECT YEAR AS ANO,
       AVG(S.PROFIT) AS PROMEDIO_BENEFICIOS,
       STDDEV(S.PROFIT) AS DESVIACION_BENEFICIOS,
       MIN(S.PROFIT) AS MINIMO_BENEFICIO,
       MAX(S.PROFIT) AS MAXIMO_BENEFICIO,
       COUNT (DISTINCT A.ACCOUNT) AS TOTAL_CLIENTES,
       COUNT (DISTINCT S.CATEGORY) AS TOTAL_CATEGORIAS,
FROM ACCOUNTS AS A FULL JOIN SALES AS S
ON A.ACCOUNT = S.ACCOUNT
WHERE S.YEAR IN (2019, 2020, 2021)
GROUP BY S.YEAR
ORDER BY ANO;



 --Analisis exploratorio de los beneficios esperados para 2022
 
SELECT AVG(F.FORECAST) AS PROMEDIO_BENEFICIOS,
       STDDEV(F.FORECAST) AS DESVIACION_BENEFICIOS,
       MIN(F.FORECAST) AS MINIMO_BENEFICIO,
       MAX(F.FORECAST) AS MAXIMO_BENEFICIO,
       MEDIAN((F.FORECAST)) AS MEDIANA_BENEFICIO,
       SUM(F.FORECAST) AS SUMATORIO_BENEFICIOS,
FROM FORECASTS AS F

 

--Promedio de beneficios en cada año por categoria


SELECT COALESCE(S.YEAR, F.YEAR) AS ANO,
       COALESCE(S.CATEGORY, F.CATEGORY) AS CATEGORIA_DE_PRODUCTO, 
       AVG(PROFIT) AS MEDIA_BENEFICIO, 
       AVG(FORECAST) AS PREVISION_MEDIA_BENEFICIO
FROM SALES AS S FULL JOIN FORECASTS AS F
ON S.YEAR = F.YEAR
    AND S.CATEGORY = F.CATEGORY
GROUP BY 
    COALESCE(S.YEAR, F.YEAR),
    COALESCE(S.CATEGORY, F.CATEGORY)
ORDER BY ANO ASC;



--Analisis de diferencias de beneficios que genera cada categoria 

SELECT COALESCE (S.CATEGORY, F.CATEGORY) AS CATEGORIA,
       SUM(CASE WHEN S.YEAR = 2019 THEN S.PROFIT ELSE 0 END) AS BENEFICIOS_TOTALES_2019,
       SUM(CASE WHEN S.YEAR = 2020 THEN S.PROFIT ELSE 0 END) AS BENEFICIOS_TOTALES_2020,
       SUM(CASE WHEN S.YEAR = 2021 THEN S.PROFIT ELSE 0 END) AS BENEFICIOS_TOTALES_2021,
       SUM(CASE WHEN F.YEAR = 2022 THEN F.FORECAST ELSE 0 END) AS BENEFICIOS_TOTALES_2022
FROM SALES AS S FULL OUTER JOIN FORECASTS AS F
ON S.CATEGORY = F.CATEGORY
GROUP BY COALESCE (S.CATEGORY, F.CATEGORY)
ORDER BY CATEGORIA



--Analisis de los paises que asegurarán mas ventas, agrupados por cliente  

SELECT DISTINCT A.ACCOUNT AS CLIENTE, A.REGION AS REGION, A.COUNTRY AS PAISES, 
CASE
    WHEN PREDICTION_CATEGORY = 'Commit' THEN 'Segura'
    WHEN PREDICTION_CATEGORY = 'Pipeline' THEN 'Probable'
    WHEN PREDICTION_CATEGORY = 'Upside' THEN 'Improbable'
ELSE 'No hay registros'
END AS PROBABILIDAD_VENTA 
FROM ACCOUNTS AS A INNER JOIN FORECASTS AS F
ON A.ACCOUNT = F.ACCOUNT
GROUP BY A.ACCOUNT, A.REGION, A.COUNTRY, F.PREDICTION_CATEGORY 
ORDER BY REGION;


--Total paises y regiones 

SELECT 
    REGION,
    COUNT(DISTINCT COUNTRY) AS TOTAL_REGIONES,
    COUNT(DISTINCT COUNTRY) * 100.0
        / SUM(COUNT(DISTINCT COUNTRY)) OVER () AS PORCENTAJE_TOTAL
FROM ACCOUNTS
GROUP BY REGION
ORDER BY REGION;


--Paises y Regiones que generan mas clientes 

SELECT A.COUNTRY AS PAIS,
       A.REGION AS REGION,
       COUNT (*) AS TOTAL_PAISES,
       COUNT(*) AS TOTAL_CATEGORIA_REGION,
       SUM(COUNT(*)) OVER (PARTITION BY A.REGION) AS TOTAL_REGION,
       ROUND(
        (COUNT(*) * 100.0) 
        / SUM(COUNT(*)) OVER (PARTITION BY A.REGION)
        , 2
    ) AS PORCENTAJE_REGION
FROM ACCOUNTS AS A JOIN SALES AS S
ON A.ACCOUNT = S.ACCOUNT
GROUP BY A.REGION, A.COUNTRY
ORDER BY REGION
;

--Analizamos los beneficios por regiones 

SELECT 
      A.REGION AS REGION, 
      A.COUNTRY AS PAIS, 
      AVG(S.TOTAL) AS INGRESO_TOTAL, 
      AVG(S.UNITS_SOLD) AS PROMEDIO_UNIDADES_VENDIDAS,
      AVG(S.PROFIT) AS BENEFICIO_PROMEDIO,
FROM ACCOUNTS AS A JOIN SALES AS S
ON A.ACCOUNT = S.ACCOUNT
GROUP BY A.REGION, A.COUNTRY
ORDER BY REGION
